name: 's3_publish-files'
description: 's3_publish-files'

runs:
  using: 'composite'
  steps:

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id    : ${{ env.AWS_ACCESS_KEY_ID__654654216424     }}
        aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY__654654216424 }}
        aws-region           : ${{ env.AWS_DEFAULT_REGION__654654216424    }}

    - name: Git Update Current Branch
      uses: owasp-sbot/OSBot-GitHub-Actions/.github/actions/git__update_branch@dev

    - name: Set $Version from file
      uses: owasp-sbot/OSBot-GitHub-Actions/.github/actions/git__read_version@dev

    - name: Sync files to S3
      shell: bash
      run: |               
            aws s3 sync                                                                                       \
                ./cbr_web_components s3://cyber-boardroom-654654216424-public/cbr-web-components/${VERSION}/  \
                --delete                                                                                      \
                --cache-control "public, max-age=3600"
    
            aws s3 sync                                                                                       \
                ./cbr_web_components s3://cyber-boardroom-654654216424-public/cbr-web-components/latest/      \
                --delete                                                                                      \
                --cache-control "public, max-age=3600"

    - name: Invalidate CloudFront Cache
      shell: bash
      run: |
            aws cloudfront create-invalidation              \  
                --distribution-id ${CLOUDFRONT_DIST_ID}     \
                --paths "/cbr-web-components/latest/*"